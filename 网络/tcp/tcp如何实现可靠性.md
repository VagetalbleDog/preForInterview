# TCP如何实现可靠性？

为了实现数据的可靠传输，需要考虑很多事情，数据的破坏，丢包、重复、以及分片顺序混乱等。

伟大的TCP协议主要通过 **重传机制**、**滑动窗口**、**流量控制**、**拥塞控制** 四个方面实现可靠传输

## 重传机制
TCP实现可靠传输的方式之一，是序列号和确认应答号。一旦确认应答号没有收到，那么就会触发重传机制。

### 超时重传

在发送数据时，设置一个定时器，当超过指定时间后，没有收到对方的ACK确认应答报文，就会重发该数据。

两种情况会触发超时重传：

 - 数据包丢失
 - 确认应答丢失

超时重发的数据，如果再次超时，这个指定时间就会加倍，两次超时后，取消重发。

### 快速重传

不以时间为驱动，而是以数据驱动重传。

某次，发送方发出了 1，2，3，4，5 五份数据 （5是窗口大小）

假设数据2丢失，那么后三个数据包，会连续返回 ACK=2，代表下一个数据包是2，这里就会直接触发重传

## 滑动窗口

TCP是每发送一个数据，都要进行确认应答。必须等上一个数据的确认应答回来，再发送下一个。这么做，效率是很低的，造成网络吞吐量低的离谱。

为了解决这个问题，TCP引入了**窗口**的概念，代表一次性可以发送几个数据包，也就是`无需等待确认应答，而可以继续发送数据的最大值`

窗口的实现实际上就是操作系统开辟的一片缓存区，当发送方发送这些数据后，如果收到确认应答，就从缓存区中删除，如果没有收到的话，直接从缓存区中重发。

而且中途如果有ACK丢失了，可以通过下一个ACK确认

### 窗口大小怎么确定

TCP头里有一个字段叫`window`，是接收方用于告诉发送方，自己还有多少缓冲区可以接收数据，于是发送端就可以根据这个大小来发送数据。

接收方的窗口大小约等于发送窗口的大小

## 流量控制

发送方不能无脑的发数据给接收方，要考虑接受方的处理能力。

如果一直无脑给接收方发送数据，就会导致接收方处理不过来，然后触发重传机制，引起网络资源浪费。

TCP提供一种机制可以让发送方根据接受方的实际接受能力控制发送的数据量，这就是**流量控制**

简而言之就是，窗口大小是根据操作系统的缓存区大小，动态变化的，随时会收缩或增大窗口大小

## 拥塞控制

TCP拥塞控制机制，是为了应对网络拥堵的 

在网络出现拥堵的情况下，很容易出现 超时、丢包 等情况，那么如果超时触发重传，那么就会更拥堵。。。

拥塞控制主要是发送方维护的一个状态变量—— `拥塞窗口(cwnd)` 

发送窗口 = 接受窗口 和 拥塞窗口 的最小值

如果网络环境流畅，拥塞窗口就会增大，反之拥塞窗口就会减小

### 慢启动
TCP刚建立连接后，一点一点提高发送数据包的数量，每收到一个ACK，拥塞窗口大小+1
发包的个数，成指数增长

### 拥塞避免
前面说过，TCP的发包数量由于慢启动机制的存在，是由指数增长的，那么很快就可能造成网络拥塞，所以会设置一个 `慢启动门限(ssthresh)` ，当超过慢启动门限后，拥塞窗口 每次增加 1/cwnd，成线性增长

### 拥塞发生
当发生超时重传时，慢启动门限 缩减为原来的一半，拥塞窗口会直接重置成1，然后重新慢启动

当发送快速重传时，拥塞窗口 缩减为原来的一半，慢启动门限 设置为拥塞窗口（减半后），进入快速恢复算法

### 快速恢复

cwnd = ssthresh + 3（三次重复ACK导致快速重传）

后续以线性增长。
